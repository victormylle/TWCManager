{% if url.path == "/teslaAccount/False" %}
   <font color='red'>
     <b>Failed to log in to Tesla Account. Please check username and password and try again.</b>
   </font>
{% elif url.path.startswith("/teslaAccount/MFA") %}
  {% set transaction_id = url.path.split("/")|last %}
    <b>Please enter the passcode generated by your authenticator app.</b>
    <form method=POST action="/teslaAccount/mfaCode">
    <input type=hidden name="transactionID" value="{{ transaction_id }}" />
    <table>
      <tr>
        <td width = 20%>
          <select name="mfaDevice" class='form-control'>
          {% for device in getMFADevices(transaction_id) %}
            <option value="{{ device["id"] }}">
            {{ device["factorProvider"] }}
            {{ device["factorType"] }}
            </option>
          {% endfor %}
        </td>
        <td width = 10%>
          <input type=text class='form-control' name="mfaCode" size=6>
        </td>
        <td>
          {{ addButton(
              ["submit_tesla_mfa", "Send MFA Code"],
              "class='btn btn-outline-success'",
          )|safe }}
        </td>
      </tr>
    </table>
    </form>
{% elif url.path == "/teslaAccount/NotSpecified" %}
  <font color='red'>
    <b>Error: You did not specify both a username and password.</b>
  </font>
{% elif url.path == "/teslaAccount/Phase1Error" %}
  <font color='red'>
    <b>Error encountered during Phase 1 (GET) of the Tesla Authentication process.</b>
  </font>
{% elif url.path == "/teslaAccount/Phase1Captcha" %}
  <font color='black'>
    <b>Tesla Login has requested a Captcha code for this login session. Please type the characters shown on the Captcha image into the textbox below.</b>

    <br><img src="/teslaAccount/getCaptchaImage" style="width:400px;height:200px;" />

    <form action="/teslaAccount/submitCaptcha" method=POST>
      Enter Captcha Code:
      <input type=text size=6 name=captchaCode />
      <input type=hidden name=interface value="captcha" />
      <input type=submit value="Send Captcha" />
    </form>
  </font>
{% elif url.path == "/teslaAccount/Phase1Recaptcha" %}
  <font color='black'>
    <b>Tesla have added ReCaptcha login validation which we can't integrate with our login flow.</b>
  </font>

  <br/>Your options are:

  <ul>
    <li>Use an app to authenticate to Tesla and obtain tokens. These can be entered under the Settings menu.</li>
    <ul>
      <li><a href="https://apps.apple.com/us/app/auth-app-for-tesla/id1552058613#?platform=iphone">Auth app for Tesla (iOS)</a></li>
      <li><a href="https://play.google.com/store/apps/details?id=net.leveugle.teslatokens">Tesla Tokens (Android)</a></li>
      <li><a href="https://github.com/adriankumpf/tesla_auth">Tesla Auth (macOS, Linux, Windows)</a></li>
    </ul>
    <li>Configure Token Sync with an external application like <a href="https://github.com/ngardiner/TWCManager/blob/main/docs/modules/Vehicle_TeslaMate.md" target="_blank">TeslaMate</a></li>

    {% if host and host.endswith('.tesla.com') %}
      <li>Congrats: Because your site is configured with a .tesla.com suffix, you can use the ReCaptcha prompt below.</li>
    {% else %}
      <li>You could perform a <a href="https://github.com/ngardiner/TWCManager/blob/main/docs/TeslaAPI_Rediection.md">DNS redirection trick</a> to host TWCManager on a tesla.com domain. </li>
    {% endif %}
  </ul>

  {% if host and host.endswith('.tesla.com') %}

    <div id="captcha_container"></div>

    <form id="captchaForm" method=POST action="/teslaAccount/submitCaptcha">
      <input type=hidden size=6 name=captchaCode id=captchaCode />
      <input type=hidden name=interface value="recaptcha" />
    </form>

    <script>
     function onSubmit(token) {
       document.getElementById("captchaCode").value = token;
       document.getElementById("captchaForm").submit();
     }

    function loadCaptcha() {
      grecaptcha.render('captcha_container', {
        'sitekey' : '6LdUQhgUAAAAAEe8NWX3Rur9bQRqq-2RUPhthpJs',

        'badge': 'bottom-right',
        'callback' : onSubmit
      });
      }
    </script>

    <script src="https://www.google.com/recaptcha/api.js?onload=loadCaptcha&render=explicit" async defer></script>
  {% endif %}

{% elif url.path == "/teslaAccount/Phase2Error" or url.path == "/teslaAccount/Phase2ErrorTip" %}
  <font color='red'>
    <b>Error encountered during Phase 2 (POST) of the Tesla Authentication process.</b>
    {% if url.path == "/teslaAccount/Phase2ErrorTip" %}
       <p><b>TIP: If login fails at this point, it <i>could</i> be due to a locked Tesla account from too many login attempts, even if the last attempt was the correct password. Try logging out and then into your Tesla account to verify</b></p>
    {% endif %}
  </font>
{% elif url.path == "/teslaAccount/TokenLengthError" %}
  <font color="red">
    <b>Tesla Login Failed: The MFA token code entered was too short - token code should be 6 characters.</b>
  </font>
{% elif url.path == "/teslaAccount/TokenFail" %}
  <font color="red">
    <b>Tesla Login Failed: No known error was reported. Please check logs for more detail.
    <br /> This error can occur if your MFA Token Code was wrong.
  </font>
{% endif %}

{% if not master.teslaLoginAskLater
      and not master.tokenSyncEnabled()
      and url.path != "/teslaAccount/True"
      and not url.path.startswith("/teslaAccount/MFA")
      and not url.path == "/teslaAccount/Phase1Captcha"
      and not url.path == "/teslaAccount/Phase1Recaptcha" %}
      <!-- Check if we have already stored the Tesla credentials
           If we can access the Tesla API okay, don't prompt -->
      {% if not apiAvailable %}
          {% include 'request_teslalogin.html.j2' %}
      {% endif %}
{% endif %}
{% if url.path == "/teslaAccount/True" %}
   <b>Thank you, successfully fetched Tesla API token.</b>
{% endif %}
